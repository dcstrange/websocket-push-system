# WebSocket异步推送系统（简易版）

## 详细架构图

```
+----------------------------------+
|          浏览器前端               |
|  +----------------------------+  |
|  |        用户界面             |  |
|  +----------------------------+  |
|              ↑↓                 |
|  +----------------------------+  |
|  |      WebSocket客户端        |  |
|  +----------------------------+  |
+----------------------------------+
              ↑↓
              │
              │ WebSocket连接
              │ (ws://服务器地址:端口)
              │
+----------------------------------+
|          服务器后端               |
|  +----------------------------+  |
|  |     WebSocket服务器        |  |
|  |  +-----------------------+ |  |
|  |  | 连接管理              | |  |
|  |  | (用户ID → WebSocket)  | |  |
|  |  +-----------------------+ |  |
|  |           ↑↓              |  |
|  |  +-----------------------+ |  |
|  |  | 认证管理 (JWT)        | |  |
|  |  +-----------------------+ |  |
|  |           ↑↓              |  |
|  |  +-----------------------+ |  |
|  |  | 内存任务队列          | |  |
|  |  +-----------------------+ |  |
|  |           ↑↓              |  |
|  |  +-----------------------+ |  |
|  |  | 任务处理器            | |  |
|  |  +-----------------------+ |  |
|  +----------------------------+  |
+----------------------------------+
```

## 架构说明

1. **浏览器前端**
   - **用户界面**：用户交互界面，包括登录表单和数据请求表单
   - **WebSocket客户端**：建立与服务器的WebSocket连接，处理消息收发和重连

2. **服务器后端**
   - **WebSocket服务器**：接收和维护客户端WebSocket连接
   - **连接管理**：跟踪哪些用户有活跃连接，存储用户ID与WebSocket连接的映射
   - **认证管理**：使用JWT令牌验证用户身份
   - **内存任务队列**：临时存储待处理的任务请求
   - **任务处理器**：执行耗时操作并生成结果，直接向对应用户推送数据

## 数据流程

1. 用户通过HTTP请求登录，获取JWT令牌
2. 前端建立WebSocket连接并发送认证消息（包含JWT令牌）
3. 服务器验证令牌并关联用户ID与WebSocket连接
4. 用户发送数据请求
5. 服务器将请求加入内存任务队列
6. 任务处理器执行耗时操作（模拟后台处理）
7. 处理完成后，通过WebSocket直接向用户推送JSON结果

## 运行和测试项目

### 1. 安装依赖和启动服务器

```bash
# 安装后端依赖
cd simple-ws-push
npm install

# 启动服务器
npm start
```

服务器将在3000端口启动，同时提供HTTP API和WebSocket服务。

### 2. 访问前端页面

你可以使用任何静态文件服务器来提供前端文件。例如，使用Node.js的`http-server`
执行以下命令启动服务器：

```bash
# 方法2
npm install http-server
npx http-server -p 8080

# 或方法3 (如果已安装Python)
python -m http.server 8080
```
然后在浏览器中访问 http://localhost:8080，应该就能看到你的应用了。


### 3. 测试流程

1. 打开前端页面
2. 使用预设的用户凭据登录：
   - 用户名: `user1`
   - 密码: `password1`
3. 登录成功后，WebSocket连接会自动建立并认证
4. 使用"请求数据"表单发送数据请求
5. 观察"消息日志"面板追踪请求处理过程
6. 等待几秒钟后，服务器会推送处理结果到"收到的推送数据"面板

## 简易版方案的关键优势

1. **简单易理解** - 所有组件在单个服务器进程中运行
2. **无外部依赖** - 不需要RabbitMQ等外部消息队列服务
3. **快速部署** - 只需一个Node.js环境即可运行
4. **容易扩展** - 可以根据需要添加更多功能

## 实际生产环境的注意事项

1. **内存管理** - 应添加任务和连接数量限制，防止内存溢出
2. **错误处理** - 增强错误处理和恢复机制
3. **安全性** - 加强安全措施，如使用HTTPS和WSS
4. **扩展性** - 当用户量增长时，可能需要迁移到使用消息队列的架构

这个简化版方案适合中小型应用或原型开发，能满足基本的前后端实时推送需求。